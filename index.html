<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel → Avito XML</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Excel → Avito XML</h1>
  <input id="file" type="file" accept=".xlsx,.xls" />
  <button id="convert">Скачать XML</button>

  <script>
    const REQUIRED = ['AdId','Title','Category','BusinessType','ContactPhone','Address','FranchiseFee'];

    function escapeXML(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&apos;');
    }

    function normalizePhone(s) {
      return String(s || '').replace(/\D+/g,'');
    }

    document.getElementById('convert').addEventListener('click', () => {
      const file = document.getElementById('file').files[0];
      if (!file) { alert('Выберите Excel'); return; }

      const reader = new FileReader();
      reader.onload = (e)=>{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[1] || wb.SheetNames[0]]; // второй лист, если есть
        const rows = XLSX.utils.sheet_to_json(ws, { defval:'', raw:true });

        const parts = [];
        parts.push(`<?xml version='1.0' encoding='utf-8'?>`);
        parts.push(`<Ads formatVersion="3" target="Avito.ru">`);

        rows.forEach((row, idx)=>{
          parts.push('<Ad>');

          function tag(name, value){
            if (value==null || value==='') return;
            if (['Price','FranchiseFee','Payback'].includes(name)) {
              parts.push(`<${name}>${Number(value)||0}</${name}>`);
            } else if (name==='ContactPhone') {
              parts.push(`<${name}>${normalizePhone(value)}</${name}>`);
            } else {
              parts.push(`<${name}>${escapeXML(value)}</${name}>`);
            }
          }

          tag('Id', row['Уникальный идентификатор объявления']);
          tag('AdId', row['Номер объявления на Авито']);
          tag('ManagerName', row['Контактное лицо']);
          tag('ContactPhone', row['Номер телефона']);
          tag('Address', row['Адрес']);
          tag('Category', row['Категория']);
          tag('BusinessType', row['Вид бизнеса']);
          tag('GoodsSubType', row['Вид франшизы']);
          tag('FranchiseSubType', row['Тип франшизы']);
          tag('Title', row['Название объявления']);
          tag('Description', row['Описание объявления']);
          tag('Price', row['Цена']);
          tag('ContactMethod', row['Способ связи']);
          tag('FranchiseFee', row['Паушальный взнос']);
          tag('FranchiseRoyalty', row['Роялти']);
          tag('Payback', row['Окупаемость франшизы']);
          tag('Support', row['Сопровождение']);
          tag('SupportType', row['Тип сопровождения']);
          tag('TargetAudience', row['Целевая аудитория']);
          tag('ContactEmail', row['Почта']);
          tag('DateEnd', row['AvitoDateEnd']);
          tag('VideoURL', row['Ссылка на видео']);
          tag('CompanyName', row['Название компании']);

          if (row['Ссылки на фото']) {
            const urls = String(row['Ссылки на фото']).split(/\s*[,;\n]\s*/).filter(Boolean);
            if (urls.length) {
              parts.push('<Images>');
              urls.forEach(u=> parts.push(`<Image url="${escapeXML(u)}" />`));
              parts.push('</Images>');
            }
          }

          parts.push('</Ad>');
        });

        parts.push('</Ads>');

        const blob = new Blob([parts.join('')], { type:'application/xml;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'avito.xml';
        a.click();
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
